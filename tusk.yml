options:
  uid:
    usage: User ID for local images.
    default:
      command: id -u
  gid:
    usage: Group ID for local images.
    default: 65535
  user:
    usage: Username for local images.
    default:
      command: id -un
  group:
    usage: Group name for local images.
    default:
      command: id -un
  docker_gid:
    usage: Group ID of docker group.
    default:
      command: getent group docker | cut -d ":" -f3

tasks:
  generate:
    usage: Run application generation.
    run:
      - set-environment:
          GOOS: linux
          GOARCH: amd64
      - command: prototool generate
      - command: render-templates $(pwd)
      - command: go run cmd/genshaders/main.go --dir-shaders $(pwd)/shaders --output $(pwd)/gen/shader --package-name shader
      # workarounds TODO
      - command: rm -rf ./gen/github.com

  clean:
    usage: Clean application generated files and directories.
    run:
      - command: rm -rf gen
      - command: rm -rf public

  build:
    usage: Build all apps.
    run:
      - command: build-all $(pwd)

  serve:
    usage: Run a webserver.
    run:
      - command: go run cmd/serve/main.go $(pwd)/public

  test.node:
    usage: Run tests on nodejs. tusk local.test.node ./... from the host system.
    description: Care must be taken to keep the apps runnable on browsers too.
    args:
      pkg:
        usage: Package
    run:
      - set-environment:
          GOOS: js
          GOARCH: wasm
      - command: go test -v -count=1 -exec="$(go env GOROOT)/misc/wasm/go_js_wasm_exec" ${pkg}
