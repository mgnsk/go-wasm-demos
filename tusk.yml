---
tasks:
  clean:
    usage: Clean application generated files and directories.
    run:
      - command: rm -rf public

  setup:
    usage: Install dev dependencies.
    run:
      - command: |
          cd $(mktemp -d)
          go mod init tools
          go get github.com/mgnsk/templatetool
          go install github.com/mgnsk/templatetool

  generate:
    usage: Generate javascript files.
    run:
      - command: bin/render-templates $(pwd)

  build:
    usage: Build all apps.
    run:
      - set-environment:
          GOOS: js
          GOARCH: wasm
      - command: |
          for app in ${PWD}/cmdwasm/*/
          do
              app=$(basename $app)
              echo "Building $app..."
              go build -ldflags '-s -w' -o ${PWD}/public/$app/$app.wasm ${PWD}/cmdwasm/$app/main.go
          done

  serve:
    usage: Run a webserver.
    run:
      - set-environment:
          GOOS: linux
          GOARCH: amd64
      - command: go run cmd/serve/main.go $(pwd)/public

  test.node:
    usage: Run tests on nodejs.
    args:
      pkg:
        usage: Package
    run:
      - set-environment:
          GOOS: js
          GOARCH: wasm
      - command: go mod download
      - command: go mod vendor
      - command: sed -i 's/build windows/build windows js/g' ./vendor/github.com/onsi/ginkgo/internal/remote/output_interceptor_win.go
      - command: go test -mod=vendor -v -count=1 -exec="env --ignore-environment ${GOROOT}/misc/wasm/go_js_wasm_exec" ${pkg}
