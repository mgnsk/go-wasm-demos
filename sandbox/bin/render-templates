#!/bin/bash
trap onerr ERR

onerr(){ while caller $((n++)); do :; done; }

set -o errexit
set -o pipefail
set -o nounset


GOROOT=$(go env GOROOT)

# Hack around the templatetool for single file single template rendering
# The template name and the filename are the same.
function render {
    export TPL_GLOB=$1
    tplName=$(basename $1)
    shift
    templatetool $tplName "$@"
}

wasmExecJSPath="$(go env GOROOT)/misc/wasm/wasm_exec.js"

echo "# Generating public dirs..."

host="http://localhost:8080"
#host="https://mgnsk.github.io/go-wasm-demos/public"

# Render public dirs for all wasm apps.
rm -rf /app/public/

for app in /app/cmdwasm/*/
do
    app=$(basename $app)

    echo "$app"

    mkdir -p /app/public/$app/

    render /app/template/index.js.tpl \
        --WasmExecJS "$(cat $wasmExecJSPath)" \
        --WasmURL "$host/$app/$app.wasm" > /app/public/$app/index.js

    render /app/template/index.js.go.tpl \
        --Package "$app" \
        --IndexJS "$(cat /app/public/$app/index.js | base64)" > /app/public/$app/index.js.go

    render /app/template/index.html.tpl \
        --CanvasID "gocanvas" > /app/public/$app/index.html
done

echo "# Copying static data..."

# Copy static data.
cp /app/test2.wav /app/public/test2.wav
cp /app/third_party/js/stats.min.js /app/public/stats.min.js